# 目的
Laravelで「仕様（要件）変更の履歴管理」および「テストケースの生成・管理」を一体化したプロジェクトの初版設計・骨格コードを提示します。Wordは“見栄え重視”、Excelは“加工しやすさ重視”の出力方針を盛り込みます。


**DB名：`specification_manager`**

---

# 推奨スタック
- PHP 8.2+
- Laravel 11
- DB: MySQL 8 (または PostgreSQL 14+)
- Redis（キュー/キャッシュ）
- 主要パッケージ
  - 認証/UI: `laravel/breeze`
  - 権限: `spatie/laravel-permission`
  - 変更監査（任意補助）: `spatie/laravel-activitylog`
  - Excel出力: `maatwebsite/excel`
  - Word出力: `phpoffice/phpword`
  - 差分表示: `sebastian/diff`

---

# セットアップ手順
**使用DB名**：`specification_manager`

**1) MySQL でDB作成（推奨: MySQL 8 / utf8mb4）**
```sql
CREATE DATABASE specification_manager
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_0900_ai_ci; -- MySQL 8 既定の最新汎用Collation
-- （日本語向けの厳密比較が必要なら）
-- ALTER DATABASE specification_manager COLLATE utf8mb4_ja_0900_as_cs;

CREATE USER 'spec_user'@'%' IDENTIFIED BY 'strong_password_here';
GRANT ALL PRIVILEGES ON specification_manager.* TO 'spec_user'@'%';
FLUSH PRIVILEGES;
```

**2) Laravel の .env 設定**
```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=specification_manager
DB_USERNAME=spec_user
DB_PASSWORD=strong_password_here
```

**3) 依存インストール〜マイグレーション**（DB作成・.env 設定後に実行）
```bash
composer create-project laravel/laravel spec-test-mgr
cd spec-test-mgr
composer require laravel/breeze --dev
php artisan breeze:install blade
npm i && npm run build

composer require spatie/laravel-permission spatie/laravel-activitylog maatwebsite/excel phpoffice/phpword sebastian/diff

php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider"
php artisan vendor:publish --provider="Spatie\Activitylog\ActivitylogServiceProvider"
php artisan migrate
```

---

# ドメインモデル（ER 概略）
- **projects**: プロジェクト
- **requirements**: 要件（不変キーと最新メタ）
- **spec_versions**: 要件本文の版管理（要件の内容本文/属性のバージョン履歴）
- **change_requests**: 変更要求（差分、理由、影響、承認フロー）
- **test_cases**: テストケース（要件紐づけ・自動生成フラグ）
- **test_steps**: テスト手順（各ケースの手順）
- **test_suites** / **suite_test_case**: テストスイートとケースの多対多
- **test_runs** / **test_run_results**: 実行と結果
- **attachments**: 添付（任意）
- **generation_rules**: テスト生成ルール（YAML/JSON 定義）
- **tags** / **taggables**: タグ付け（任意）

---

# マイグレーション（主要テーブル例）
`database/migrations/2025_01_01_000000_create_core_tables.php`
```php
<?php
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void {
        Schema::create('projects', function (Blueprint $table) {
            $table->id();
            $table->string('key')->unique(); // 例: PRJ-2025
            $table->string('name');
            $table->text('description')->nullable();
            $table->timestamps();
        });

        Schema::create('requirements', function (Blueprint $table) {
            $table->id();
            $table->foreignId('project_id')->constrained()->cascadeOnDelete();
            $table->string('key')->unique(); // 例: REQ-001
            $table->string('title');
            $table->string('status')->default('draft'); // draft/approved/deprecated
            $table->unsignedBigInteger('current_version_id')->nullable();
            $table->timestamps();
        });

        Schema::create('spec_versions', function (Blueprint $table) {
            $table->id();
            $table->foreignId('requirement_id')->constrained('requirements')->cascadeOnDelete();
            $table->unsignedInteger('version_no');
            $table->longText('body_md'); // 本文（Markdown）
            $table->json('attributes')->nullable(); // 優先度、対象画面など
            $table->foreignId('created_by')->nullable()->constrained('users')->nullOnDelete();
            $table->timestamps();
            $table->unique(['requirement_id','version_no']);
        });

        Schema::table('requirements', function (Blueprint $table) {
            $table->foreign('current_version_id')->references('id')->on('spec_versions')->nullOnDelete();
        });

        Schema::create('change_requests', function (Blueprint $table) {
            $table->id();
            $table->foreignId('project_id')->constrained()->cascadeOnDelete();
            $table->foreignId('requirement_id')->constrained()->cascadeOnDelete();
            $table->unsignedBigInteger('from_version_id')->nullable();
            $table->unsignedBigInteger('to_version_id')->nullable();
            $table->string('reason');
            $table->text('impact')->nullable();
            $table->string('status')->default('proposed'); // proposed/approved/rejected/implemented
            $table->foreignId('requested_by')->nullable()->constrained('users')->nullOnDelete();
            $table->foreignId('approved_by')->nullable()->constrained('users')->nullOnDelete();
            $table->timestamps();
        });

        Schema::create('test_cases', function (Blueprint $table) {
            $table->id();
            $table->foreignId('project_id')->constrained()->cascadeOnDelete();
            $table->foreignId('requirement_id')->nullable()->constrained('requirements')->nullOnDelete();
            $table->string('key')->unique(); // 例: TC-0001
            $table->string('title');
            $table->text('preconditions')->nullable();
            $table->string('priority')->default('medium'); // low/medium/high/critical
            $table->string('type')->default('functional'); // functional/api/ui 等
            $table->string('status')->default('design'); // design/ready/deprecated
            $table->boolean('auto_generated')->default(false);
            $table->timestamps();
        });

        Schema::create('test_steps', function (Blueprint $table) {
            $table->id();
            $table->foreignId('test_case_id')->constrained()->cascadeOnDelete();
            $table->unsignedInteger('step_no');
            $table->text('action');
            $table->text('expected');
            $table->timestamps();
            $table->unique(['test_case_id','step_no']);
        });

        Schema::create('test_suites', function (Blueprint $table) {
            $table->id();
            $table->foreignId('project_id')->constrained()->cascadeOnDelete();
            $table->string('name');
            $table->text('description')->nullable();
            $table->timestamps();
        });

        Schema::create('suite_test_case', function (Blueprint $table) {
            $table->id();
            $table->foreignId('test_suite_id')->constrained('test_suites')->cascadeOnDelete();
            $table->foreignId('test_case_id')->constrained('test_cases')->cascadeOnDelete();
            $table->unique(['test_suite_id','test_case_id']);
        });

        Schema::create('test_runs', function (Blueprint $table) {
            $table->id();
            $table->foreignId('project_id')->constrained()->cascadeOnDelete();
            $table->foreignId('test_suite_id')->nullable()->constrained('test_suites')->nullOnDelete();
            $table->string('name');
            $table->timestamp('executed_at')->nullable();
            $table->foreignId('executed_by')->nullable()->constrained('users')->nullOnDelete();
            $table->timestamps();
        });

        Schema::create('test_run_results', function (Blueprint $table) {
            $table->id();
            $table->foreignId('test_run_id')->constrained('test_runs')->cascadeOnDelete();
            $table->foreignId('test_case_id')->constrained('test_cases')->cascadeOnDelete();
            $table->string('status')->default('not_run'); // pass/fail/blocked/not_run
            $table->text('actual')->nullable();
            $table->string('defect_url')->nullable();
            $table->timestamps();
            $table->unique(['test_run_id','test_case_id']);
        });

        Schema::create('generation_rules', function (Blueprint $table) {
            $table->id();
            $table->foreignId('project_id')->constrained()->cascadeOnDelete();
            $table->string('name');
            $table->text('description')->nullable();
            $table->longText('definition_yaml');
            $table->boolean('enabled')->default(true);
            $table->timestamps();
        });
    }

    public function down(): void {
        Schema::dropIfExists('generation_rules');
        Schema::dropIfExists('test_run_results');
        Schema::dropIfExists('test_runs');
        Schema::dropIfExists('suite_test_case');
        Schema::dropIfExists('test_suites');
        Schema::dropIfExists('test_steps');
        Schema::dropIfExists('test_cases');
        Schema::dropIfExists('change_requests');
        Schema::table('requirements', function (Blueprint $table) { $table->dropForeign(['current_version_id']); });
        Schema::dropIfExists('spec_versions');
        Schema::dropIfExists('requirements');
        Schema::dropIfExists('projects');
    }
};
```

---

# Eloquent モデル（抜粋）
`app/Models/Requirement.php`
```php
<?php
namespace App\Models;
use Illuminate\Database\Eloquent\Model;

class Requirement extends Model
{
    protected $fillable = ['project_id','key','title','status','current_version_id'];

    public function project(){ return $this->belongsTo(Project::class); }
    public function versions(){ return $this->hasMany(SpecVersion::class); }
    public function currentVersion(){ return $this->belongsTo(SpecVersion::class, 'current_version_id'); }
    public function changeRequests(){ return $this->hasMany(ChangeRequest::class); }
    public function testCases(){ return $this->hasMany(TestCase::class); }
}
```

`app/Models/SpecVersion.php`
```php
<?php
namespace App\Models;
use Illuminate\Database\Eloquent\Model;

class SpecVersion extends Model
{
    protected $fillable=['requirement_id','version_no','body_md','attributes','created_by'];
    protected $casts=['attributes'=>'array'];
    public function requirement(){ return $this->belongsTo(Requirement::class); }
}
```

`app/Models/TestCase.php`
```php
<?php
namespace App\Models;
use Illuminate\Database\Eloquent\Model;

class TestCase extends Model
{
    protected $fillable=['project_id','requirement_id','key','title','preconditions','priority','type','status','auto_generated'];
    public function steps(){ return $this->hasMany(TestStep::class); }
    public function requirement(){ return $this->belongsTo(Requirement::class); }
}
```

---

# 仕様変更の登録フロー（Controller抜粋）
`app/Http/Controllers/RequirementController.php`
```php
<?php
namespace App\Http\Controllers;
use App\Models\{Requirement, SpecVersion, ChangeRequest};
use Illuminate\Http\Request;
use SebastianBergmann\Diff\Differ;

class RequirementController extends Controller
{
    public function store(Request $request){
        $data = $request->validate([
            'project_id'=>'required|exists:projects,id',
            'key'=>'required|unique:requirements,key',
            'title'=>'required',
            'body_md'=>'required',
            'attributes'=>'array'
        ]);
        $req = Requirement::create($data);
        $v = SpecVersion::create([
            'requirement_id'=>$req->id,
            'version_no'=>1,
            'body_md'=>$data['body_md'],
            'attributes'=>$data['attributes'] ?? [],
            'created_by'=>auth()->id(),
        ]);
        $req->update(['current_version_id'=>$v->id,'status'=>'approved']);
        return redirect()->route('requirements.show',$req);
    }

    public function update(Request $request, Requirement $requirement){
        $data = $request->validate([
            'title'=>'required',
            'body_md'=>'required',
            'attributes'=>'array',
            'reason'=>'required',
            'impact'=>'nullable'
        ]);

        $current = $requirement->currentVersion;
        $nextNo = ($requirement->versions()->max('version_no') ?? 0) + 1;

        $new = SpecVersion::create([
            'requirement_id'=>$requirement->id,
            'version_no'=>$nextNo,
            'body_md'=>$data['body_md'],
            'attributes'=>$data['attributes'] ?? [],
            'created_by'=>auth()->id(),
        ]);

        $diff = (new Differ("\n"))->diff($current->body_md, $new->body_md);

        $cr = ChangeRequest::create([
            'project_id'=>$requirement->project_id,
            'requirement_id'=>$requirement->id,
            'from_version_id'=>$current->id,
            'to_version_id'=>$new->id,
            'reason'=>$data['reason'],
            'impact'=>$data['impact'] ?? null,
            'status'=>'proposed',
            'requested_by'=>auth()->id(),
        ]);

        // 承認は別アクションで。承認時に current_version_id を更新
        return redirect()->route('change-requests.show', $cr);
    }

    public function approve(ChangeRequest $cr){
        $cr->update(['status'=>'approved','approved_by'=>auth()->id()]);
        $cr->requirement->update(['current_version_id'=>$cr->to_version_id]);
        return back();
    }
}
```

---

# テストケース自動生成（ルール駆動）
- **generation_rules.definition_yaml** 例
```yaml
match:
  attributes.priority: [high, critical]
actions:
  - create_case:
      title: "必須経路: {{ requirement.title }}"
      steps:
        - action: "前提を満たす"
          expected: "前提が満たされる"
        - action: "主要フローを実行"
          expected: "期待結果が得られる"
  - create_case:
      title: "エッジケース: {{ requirement.key }} 入力バリデーション"
      steps:
        - action: "無効な入力を与える"
          expected: "適切なエラー表示"
```

- **サービス層** `app/Services/TestCaseGeneratorService.php`
```php
<?php
namespace App\Services;
use App\Models\{Requirement, TestCase, TestStep, GenerationRule};
use Illuminate\Support\Str;
use Symfony\Component\Yaml\Yaml;

class TestCaseGeneratorService
{
    public function generateForRequirement(Requirement $req): array
    {
        $created = [];
        $rules = GenerationRule::where('project_id',$req->project_id)->where('enabled',true)->get();
        foreach ($rules as $rule) {
            $def = Yaml::parse($rule->definition_yaml);
            if ($this->matches($def['match'] ?? [], $req)) {
                foreach (($def['actions'] ?? []) as $action) {
                    if (isset($action['create_case'])) {
                        $tpl = $action['create_case'];
                        $title = $this->interpolate($tpl['title'], $req);
                        $tc = TestCase::create([
                            'project_id'=>$req->project_id,
                            'requirement_id'=>$req->id,
                            'key'=> $this->nextKey($req->project_id),
                            'title'=>$title,
                            'status'=>'design','auto_generated'=>true
                        ]);
                        foreach ($tpl['steps'] as $i=>$s) {
                            TestStep::create([
                                'test_case_id'=>$tc->id,
                                'step_no'=>$i+1,
                                'action'=>$this->interpolate($s['action'],$req),
                                'expected'=>$this->interpolate($s['expected'],$req),
                            ]);
                        }
                        $created[] = $tc;
                    }
                }
            }
        }
        return $created;
    }

    private function matches(array $cond, Requirement $req): bool
    {
        // 単純な attributes マッチのみ例示
        foreach ($cond as $path => $values) {
            $val = data_get($req->currentVersion->attributes, str_replace('attributes.','',$path));
            if (!in_array($val, $values ?? [])) return false;
        }
        return true;
    }

    private function interpolate(string $tpl, Requirement $req): string
    {   return strtr($tpl,[
            '{{ requirement.title }}'=>$req->title,
            '{{ requirement.key }}'=>$req->key,
        ]);
    }

    private function nextKey(int $projectId): string
    {   $n = TestCase::where('project_id',$projectId)->count()+1;
        return 'TC-'.str_pad((string)$n,4,'0',STR_PAD_LEFT);
    }
}
```

- **コンソールコマンド** `app/Console/Commands/GenerateTestCases.php`
```php
<?php
namespace App\Console\Commands;
use Illuminate\Console\Command;
use App\Services\TestCaseGeneratorService;
use App\Models\{Project, Requirement};

class GenerateTestCases extends Command
{
    protected $signature = 'tests:generate {--project=} {--requirement=}';
    protected $description = 'ルールに基づきテストケースを自動生成';

    public function handle(TestCaseGeneratorService $svc)
    {
        if ($id = $this->option('requirement')) {
            $req = Requirement::findOrFail($id);
            $created = $svc->generateForRequirement($req);
            $this->info("Created: ".count($created));
            return self::SUCCESS;
        }
        $project = Project::findOrFail($this->option('project'));
        $cnt = 0;
        foreach ($project->requirements as $req) $cnt += count($svc->generateForRequirement($req));
        $this->info("Created: {$cnt}");
        return self::SUCCESS;
    }
}
```

`app/Console/Kernel.php` に登録：
```php
protected $commands = [\App\Console\Commands\GenerateTestCases::class];
```

---

# Excel 出力（加工しやすさ重視）
- 方針：1行ヘッダのみ、固定列順、ISO8601日時、数式/書式最小化、結合セルなし。
- 例）**テストケース一覧**導出

`app/Exports/TestCasesExport.php`
```php
<?php
namespace App\Exports;
use App\Models\TestCase;
use Maatwebsite\Excel\Concerns\FromArray;
use Maatwebsite\Excel\Concerns\WithHeadings;

class TestCasesExport implements FromArray, WithHeadings
{
    public function headings(): array {
        return ['project_key','tc_key','title','priority','type','status','requirement_key','updated_at'];
    }
    public function array(): array {
        return TestCase::with('requirement.project')
            ->get()->map(function($tc){
                return [
                    optional($tc->requirement->project)->key,
                    $tc->key,
                    $tc->title,
                    $tc->priority,
                    $tc->type,
                    $tc->status,
                    optional($tc->requirement)->key,
                    $tc->updated_at?->toIso8601String(),
                ];
            })->toArray();
    }
}
```

`app/Http/Controllers/ExportController.php`
```php
<?php
namespace App\Http\Controllers;
use Maatwebsite\Excel\Facades\Excel;
use App\Exports\TestCasesExport;

class ExportController extends Controller
{
    public function testCases(){
        return Excel::download(new TestCasesExport(),'test_cases.xlsx');
    }
}
```

---

# Word 出力（見栄え重視）
- 方針：**テンプレートDOCX**を `storage/app/templates/` に置き、ロゴ・表紙・ヘッダ/フッタ・スタイル（見出し1〜3、本文、表）を整える。
- 例）**変更履歴レポート**：

`app/Http/Controllers/WordReportController.php`
```php
<?php
namespace App\Http\Controllers;
use PhpOffice\PhpWord\TemplateProcessor;
use App\Models\{Project, ChangeRequest};
use Illuminate\Support\Str;

class WordReportController extends Controller
{
    public function changeLog(Project $project)
    {
        $tpl = new TemplateProcessor(storage_path('app/templates/change_log.docx'));
        $tpl->setValue('project_name', $project->name);
        $tpl->setValue('generated_at', now()->format('Y-m-d H:i'));

        $rows = $project->changeRequests()->with(['requirement','fromVersion','toVersion'])->latest()->get();
        // テーブル複製: block 名はテンプレート側で table_row とする
        $tpl->cloneRow('cr_id', $rows->count());
        foreach ($rows as $i=>$cr) {
            $n = $i+1;
            $tpl->setValue("cr_id#{$n}", $cr->id);
            $tpl->setValue("cr_req_key#{$n}", $cr->requirement->key);
            $tpl->setValue("cr_from#{$n}", optional($cr->fromVersion)->version_no);
            $tpl->setValue("cr_to#{$n}", optional($cr->toVersion)->version_no);
            $tpl->setValue("cr_reason#{$n}", $cr->reason);
            $tpl->setValue("cr_status#{$n}", $cr->status);
            $tpl->setValue("cr_impact#{$n}", Str::limit($cr->impact, 120));
        }
        $file = storage_path('app/reports/change_log_'.$project->key.'.docx');
        $tpl->saveAs($file);
        return response()->download($file)->deleteFileAfterSend(true);
    }
}
```

---

# 画面（Blade 抜粋）
**要件詳細＋差分表示** `resources/views/requirements/show.blade.php`
```blade
<x-app-layout>
  <h1 class="text-2xl font-bold mb-4">{{ $requirement->key }} {{ $requirement->title }}</h1>
  <div class="mb-4">現行版: v{{ $requirement->currentVersion->version_no }}</div>
  <div class="prose max-w-none">{!! Str::markdown($requirement->currentVersion->body_md) !!}</div>

  <h2 class="text-xl mt-8 font-semibold">変更履歴</h2>
  <ul class="list-disc pl-6">
    @foreach($requirement->versions()->latest('version_no')->get() as $v)
      <li>v{{ $v->version_no }} / {{ $v->created_at->format('Y-m-d') }}</li>
    @endforeach
  </ul>

  @isset($diff)
  <h2 class="text-xl mt-6 font-semibold">直近差分</h2>
  <pre class="bg-gray-100 p-3 overflow-auto">{!! $diff !!}</pre>
  @endisset
</x-app-layout>
```

差分は Controller 側で `Sebastian\Diff\Differ` により生成した HTML を渡します（上の update 参照）。

---

# ルーティング（例）
`routes/web.php`
```php
use App\Http\Controllers\{RequirementController, ExportController, WordReportController};

Route::resource('projects', ProjectController::class);
Route::resource('requirements', RequirementController::class);
Route::post('change-requests/{cr}/approve', [RequirementController::class,'approve'])->name('change-requests.approve');

Route::get('exports/test-cases', [ExportController::class,'testCases'])->name('exports.test-cases');
Route::get('reports/{project}/change-log.docx', [WordReportController::class,'changeLog'])->name('reports.change-log');
```

---

# 権限設計（例）
- 役割：`admin`, `pm`, `qa`, `viewer`
- パーミッション例：`requirements.create`, `requirements.approve`, `testcases.generate`, `exports.download`
- `spatie/laravel-permission` でロール-権限を Seeder で付与

---

# 監査ログ（任意強化）
`spatie/laravel-activitylog` で `Requirement`, `TestCase` 更新時に `causer_id`, 変更属性を自動記録。DB の版管理（spec_versions）と併用で、**履歴の真正性+再現性**を確保します。

---

# レポート/集計（指標例）
- 変更要求の承認リードタイム（日）
- 要件→テストケース **カバレッジ率**（要件数対網羅ケース数）
- ランごとの合格率 / ブロック率

---

# 次の実装タスク（チェックリスト）
- [ ] 認証/権限（Breeze + Permission）導入と初期ロールSeeder
- [ ] 画面：プロジェクト/要件/変更要求/テストケース CRUD
- [ ] 生成ルール編集UI（YAMLテキストエリア + 検証）
- [ ] コンソール `tests:generate` をジョブ化＆プロジェクト単位で実行
- [ ] Excel/Word テンプレートの体裁調整（ヘッダ/表/書式）
- [ ] API化（将来Jira等連携用）

---

# 補足：出力ポリシー
- **Word（見栄え）**: 表紙/スタイル/目次/ロゴ、表は罫線/交互色、長文は段落間隔で可読性UP。
- **Excel（加工）**: 1シート1目的、列名・データ型を固定、IDやキー列を必ず含める、結合セル禁止、フィルタ既定ON。

---

このドキュメントをベースに、そのまま実装を開始できます。必要に応じて各セクションを詳細化してください。

